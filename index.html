import React, { useState } from 'react';
import { 
  Settings, 
  Eye, 
  Printer, 
  Plus, 
  Trash2, 
  ChevronRight, 
  FileText, 
  LayoutGrid, 
  ArrowLeft,
  Search,
  ChevronDown
} from 'lucide-react';

const App = () => {
  const [view, setView] = useState('home'); // 'home', 'public_detail', 'admin'
  const [selectedSopIndex, setSelectedSopIndex] = useState(null);
  const [searchQuery, setSearchQuery] = useState("");

  // Database awal SOP (Bisa ditambah oleh Admin)
  const [allSops, setAllSops] = useState([
    {
      id: 1,
      nomorSop: "400.3.8/-/436.7.1.P12/2026",
      tglBuat: "5 Januari 2026",
      tglRevisi: "-",
      tglPengesahan: "6 Januari 2026",
      disahkanOleh: "Kepala SMPN 12 Surabaya",
      judulSop: "SOP UKS (Usaha Kesehatan Sekolah)",
      dasarHukum: ["UU No. 17/2023 tentang Kesehatan", "SE Wali Kota Surabaya Gerakan Sekolah Sehat"],
      kualifikasi: ["Memahami P3K", "Petugas Admin Sekolah"],
      keterkaitan: ["Prosedur Pelayanan Siswa"],
      peralatan: ["Buku Register", "Kotak P3K"],
      peringatan: ["Kasus berat segera rujuk ke Puskesmas"],
      pendataan: ["Laporan bulanan kunjungan"],
      prosedur: [
        { id: 1, uraian: "Membuka ruang UKS", pelaksana: "Petugas UKS", syarat: "Kunci", waktu: "5 Menit", output: "Siap", tipe: "start" },
        { id: 2, uraian: "Pengecekan Kebersihan", pelaksana: "Petugas Kebersihan", syarat: "Alat Pel", waktu: "10 Menit", output: "Bersih", tipe: "process" }
      ],
      ttd: { tempat: "Surabaya", tanggal: "15 Des 2025", nama: "DARTO, M.Pd.", pangkat: "Pembina Tk. I", nip: "197012062008011010" }
    },
    {
      id: 2,
      nomorSop: "005/-/436.7.1.P12/2026",
      judulSop: "Prosedur Pengelolaan Surat Keluar",
      tglBuat: "10 Januari 2026",
      tglRevisi: "-",
      tglPengesahan: "11 Januari 2026",
      disahkanOleh: "Kepala SMPN 12 Surabaya",
      dasarHukum: ["Perwali Tata Naskah Dinas"],
      kualifikasi: ["Mampu Operasi Komputer"],
      keterkaitan: ["Arsiparis"],
      peralatan: ["Buku Agenda", "Komputer"],
      peringatan: ["Nomor surat tidak boleh ganda"],
      pendataan: ["Buku Agenda"],
      prosedur: [
        { id: 1, uraian: "Pembuatan Draft Surat", pelaksana: "Administrasi", syarat: "Konsep", waktu: "30 Menit", output: "Draft", tipe: "process" }
      ],
      ttd: { tempat: "Surabaya", tanggal: "15 Des 2025", nama: "DARTO, M.Pd.", pangkat: "Pembina Tk. I", nip: "197012062008011010" }
    }
  ]);

  // Handler Navigasi
  const openSop = (index) => {
    setSelectedSopIndex(index);
    setView('public_detail');
  };

  const backToHome = () => {
    setView('home');
    setSelectedSopIndex(null);
  };

  const deleteSop = (index) => {
    if (window.confirm("Hapus SOP ini?")) {
      const newList = allSops.filter((_, i) => i !== index);
      setAllSops(newList);
    }
  };

  const addNewSop = () => {
    const template = { 
      ...allSops[0], 
      id: Date.now(), 
      judulSop: "SOP Baru", 
      nomorSop: "Baru/2026", 
      prosedur: [] 
    };
    setAllSops([...allSops, template]);
    setSelectedSopIndex(allSops.length);
    setView('admin');
  };

  // Filter Search
  const filteredSops = allSops.filter(s => s.judulSop.toLowerCase().includes(searchQuery.toLowerCase()));

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-sm print:bg-white print:p-0">
      
      {/* HEADER UTAMA - Hidden on Print */}
      <nav className="bg-white border-b sticky top-0 z-50 px-6 py-3 flex justify-between items-center shadow-sm print:hidden">
        <div className="flex items-center gap-3 cursor-pointer" onClick={backToHome}>
          <div className="bg-blue-600 p-2 rounded-lg text-white">
            <FileText size={20} />
          </div>
          <div>
            <h1 className="text-lg font-bold text-slate-800 leading-tight">E-SOP SMPN 12 Surabaya</h1>
            <p className="text-[10px] text-slate-500 font-medium tracking-wider uppercase">Sistem Informasi Standar Operasional Prosedur</p>
          </div>
        </div>

        <div className="flex gap-3">
          <button 
            onClick={() => setView('home')}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition ${view === 'home' || view === 'public_detail' ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-100'}`}
          >
            <LayoutGrid size={18} /> Katalog Publik
          </button>
          <button 
            onClick={() => setView('admin')}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition ${view === 'admin' ? 'bg-orange-50 text-orange-600' : 'text-slate-600 hover:bg-slate-100'}`}
          >
            <Settings size={18} /> Admin Panel
          </button>
        </div>
      </nav>

      {/* ROUTING VIEWS */}
      <main className="p-6 max-w-7xl mx-auto">
        
        {/* HALAMAN 1: DAFTAR MENU (HOME) */}
        {view === 'home' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div>
                <h2 className="text-2xl font-bold text-slate-800 tracking-tight">Katalog SOP Sekolah</h2>
                <p className="text-slate-500">Silahkan pilih SOP untuk melihat prosedur lengkap.</p>
              </div>
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input 
                  type="text" 
                  placeholder="Cari Judul SOP..." 
                  className="pl-10 pr-4 py-2 border border-slate-200 rounded-xl w-full md:w-80 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredSops.map((sop, idx) => (
                <div 
                  key={sop.id} 
                  className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition group cursor-pointer"
                  onClick={() => openSop(idx)}
                >
                  <div className="text-[10px] font-bold text-blue-600 mb-2 uppercase tracking-widest">{sop.nomorSop}</div>
                  <h3 className="text-lg font-bold text-slate-800 mb-4 group-hover:text-blue-600 transition h-14 line-clamp-2">{sop.judulSop}</h3>
                  <div className="flex justify-between items-center text-slate-400 pt-4 border-t">
                    <span className="text-xs flex items-center gap-1"><Printer size={12}/> Siap Cetak</span>
                    <div className="bg-slate-50 p-2 rounded-full group-hover:bg-blue-600 group-hover:text-white transition">
                      <ChevronRight size={20} />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* HALAMAN 2: PUBLIK VIEW (DETAIL) */}
        {view === 'public_detail' && selectedSopIndex !== null && (
          <div className="animate-in zoom-in-95 duration-300">
            <div className="flex justify-between items-center mb-6 print:hidden">
              <button onClick={backToHome} className="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-medium">
                <ArrowLeft size={18} /> Kembali ke Daftar
              </button>
              <button 
                onClick={() => window.print()} 
                className="bg-slate-900 text-white px-6 py-2 rounded-full flex items-center gap-2 hover:bg-black transition shadow-lg"
              >
                <Printer size={18} /> Cetak Dokumen Resmi
              </button>
            </div>
            <div className="flex flex-col gap-10">
              <KonsepSatu data={allSops[selectedSopIndex]} />
              <div className="page-break" />
              <KonsepDua data={allSops[selectedSopIndex]} />
            </div>
          </div>
        )}

        {/* HALAMAN 3: ADMIN PANEL */}
        {view === 'admin' && (
          <div className="animate-in fade-in duration-300">
             <AdminPanel 
               allSops={allSops} 
               setAllSops={setAllSops} 
               deleteSop={deleteSop} 
               addNewSop={addNewSop}
               selectedIdx={selectedSopIndex}
               setSelectedIdx={setSelectedSopIndex}
             />
          </div>
        )}

      </main>

      <style>{`
        @media print {
          .page-break { page-break-before: always; }
          body { background: white; margin: 0; }
          nav, footer, .print-hide { display: none !important; }
        }
        table td, table th { border: 1px solid black !important; }
      `}</style>
    </div>
  );
};

// --- COMPONENTS ---

const AdminPanel = ({ allSops, setAllSops, deleteSop, addNewSop, selectedIdx, setSelectedIdx }) => {
  const currentSop = selectedIdx !== null ? allSops[selectedIdx] : null;

  const updateField = (field, value) => {
    const newList = [...allSops];
    newList[selectedIdx] = { ...newList[selectedIdx], [field]: value };
    setAllSops(newList);
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
      {/* Sidebar Daftar SOP */}
      <div className="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm h-fit">
        <h3 className="font-bold text-slate-700 mb-4 px-2">Daftar SOP</h3>
        <div className="space-y-1">
          {allSops.map((sop, idx) => (
            <div 
              key={idx}
              onClick={() => setSelectedIdx(idx)}
              className={`p-3 rounded-xl cursor-pointer transition flex justify-between items-center group ${selectedIdx === idx ? 'bg-orange-50 border border-orange-200 text-orange-700' : 'hover:bg-slate-50'}`}
            >
              <div className="truncate pr-2 font-medium">{sop.judulSop}</div>
              <button onClick={(e) => { e.stopPropagation(); deleteSop(idx); }} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition">
                <Trash2 size={14}/>
              </button>
            </div>
          ))}
        </div>
        <button 
          onClick={addNewSop}
          className="w-full mt-6 py-3 bg-slate-900 text-white rounded-xl flex items-center justify-center gap-2 font-bold hover:bg-black transition"
        >
          <Plus size={18}/> Tambah SOP Baru
        </button>
      </div>

      {/* Area Edit */}
      <div className="lg:col-span-3">
        {currentSop ? (
          <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 space-y-8 animate-in slide-in-from-right-4 duration-300">
            <div className="flex justify-between items-center border-b pb-4">
              <h2 className="text-xl font-bold text-slate-800">Editor: <span className="text-orange-600 uppercase">{currentSop.judulSop}</span></h2>
              <div className="px-3 py-1 bg-green-100 text-green-700 rounded text-xs font-bold uppercase tracking-wide">Tersimpan Otomatis</div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <h4 className="font-bold text-slate-500 text-[10px] uppercase tracking-widest border-l-4 border-orange-500 pl-2">Informasi Dasar</h4>
                <div>
                  <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Judul SOP</label>
                  <input className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-200 outline-none" value={currentSop.judulSop} onChange={(e) => updateField('judulSop', e.target.value)} />
                </div>
                <div>
                  <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Nomor SOP</label>
                  <input className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-200 outline-none" value={currentSop.nomorSop} onChange={(e) => updateField('nomorSop', e.target.value)} />
                </div>
              </div>

              <div className="space-y-4">
                <h4 className="font-bold text-slate-500 text-[10px] uppercase tracking-widest border-l-4 border-orange-500 pl-2">Tanggal & Pengesahan</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Tgl Pembuatan</label>
                    <input className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-200 outline-none" value={currentSop.tglBuat} onChange={(e) => updateField('tglBuat', e.target.value)} />
                  </div>
                  <div>
                    <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Tgl Pengesahan</label>
                    <input className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-200 outline-none" value={currentSop.tglPengesahan} onChange={(e) => updateField('tglPengesahan', e.target.value)} />
                  </div>
                </div>
              </div>
            </div>

            {/* Prosedur Editor Section */}
            <div className="space-y-4 pt-6 border-t">
              <h4 className="font-bold text-slate-500 text-[10px] uppercase tracking-widest border-l-4 border-blue-500 pl-2">Uraian Langkah Kerja</h4>
              {currentSop.prosedur.map((step, sIdx) => (
                <div key={step.id} className="flex gap-4 items-start bg-slate-50 p-4 rounded-xl border border-slate-100">
                  <span className="bg-slate-200 w-8 h-8 rounded-full flex items-center justify-center font-bold text-slate-600 shrink-0">{sIdx+1}</span>
                  <div className="flex-1 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="md:col-span-2">
                      <input className="w-full border p-2 rounded text-sm mb-2" placeholder="Uraian Langkah" value={step.uraian} onChange={(e) => {
                         const newProc = [...currentSop.prosedur];
                         newProc[sIdx].uraian = e.target.value;
                         updateField('prosedur', newProc);
                      }} />
                      <div className="flex gap-2">
                        <select className="text-[10px] border rounded px-2" value={step.tipe} onChange={(e) => {
                           const newProc = [...currentSop.prosedur];
                           newProc[sIdx].tipe = e.target.value;
                           updateField('prosedur', newProc);
                        }}>
                          <option value="start">Mulai/Selesai</option>
                          <option value="process">Proses</option>
                          <option value="decision">Pilihan</option>
                        </select>
                        <input className="text-[10px] border rounded px-2 w-full" placeholder="Pelaksana" value={step.pelaksana} onChange={(e) => {
                           const newProc = [...currentSop.prosedur];
                           newProc[sIdx].pelaksana = e.target.value;
                           updateField('prosedur', newProc);
                        }} />
                      </div>
                    </div>
                    <input className="border p-2 rounded text-xs h-fit" placeholder="Persyaratan" value={step.syarat} onChange={(e) => {
                         const newProc = [...currentSop.prosedur];
                         newProc[sIdx].syarat = e.target.value;
                         updateField('prosedur', newProc);
                      }} />
                    <input className="border p-2 rounded text-xs h-fit" placeholder="Output" value={step.output} onChange={(e) => {
                         const newProc = [...currentSop.prosedur];
                         newProc[sIdx].output = e.target.value;
                         updateField('prosedur', newProc);
                      }} />
                  </div>
                  <button onClick={() => {
                     const newProc = currentSop.prosedur.filter((_, i) => i !== sIdx);
                     updateField('prosedur', newProc);
                  }} className="text-red-400 p-2"><Trash2 size={16}/></button>
                </div>
              ))}
              <button 
                onClick={() => {
                  const newProc = [...currentSop.prosedur, { id: Date.now(), uraian: "", pelaksana: "Petugas", syarat: "", waktu: "5 Menit", output: "", tipe: "process" }];
                  updateField('prosedur', newProc);
                }}
                className="w-full py-4 border-2 border-dashed border-slate-200 text-slate-400 hover:text-blue-500 hover:border-blue-500 rounded-2xl flex items-center justify-center gap-2 transition"
              >
                <Plus size={20}/> Tambah Langkah Baru
              </button>
            </div>
          </div>
        ) : (
          <div className="h-96 flex flex-col items-center justify-center bg-white rounded-2xl border border-dashed border-slate-300 text-slate-400">
            <LayoutGrid size={48} className="mb-4 opacity-20" />
            <p className="font-medium italic">Silahkan pilih SOP di sebelah kiri untuk diedit.</p>
          </div>
        )}
      </div>
    </div>
  );
};

const KonsepSatu = ({ data }) => {
  return (
    <div className="bg-white p-2 border border-black shadow-sm mx-auto" style={{ width: '210mm' }}>
      <table className="w-full border-collapse border border-black text-[11px]">
        <tbody>
          <tr>
            <td rowSpan="5" className="w-[15%] text-center p-2 border border-black">
              <div className="w-16 h-20 bg-slate-50 mx-auto flex flex-col items-center justify-center text-[8px] italic border border-slate-200">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b2/Logo_Kota_Surabaya.png" alt="Sby" className="w-10 mb-1" />
                LOGO KOTA
              </div>
            </td>
            <td rowSpan="5" className="w-[15%] text-center p-2 border border-black">
              <div className="w-16 h-20 bg-slate-50 mx-auto flex items-center justify-center text-[8px] italic border border-slate-200 font-bold text-center uppercase leading-none">
                SMPN 12<br/>SBY
              </div>
            </td>
            <td rowSpan="5" className="w-[40%] text-center font-bold p-4 border border-black align-middle leading-tight">
              PEMERINTAH KOTA SURABAYA<br />
              DINAS PENDIDIKAN<br />
              SMP NEGERI 12 SURABAYA
            </td>
            <td className="w-[15%] px-2 border border-black">Nomor SOP</td>
            <td className="w-[15%] px-2 border border-black">{data.nomorSop}</td>
          </tr>
          <tr><td className="px-2 border border-black">Tgl Pembuatan</td><td className="px-2 border border-black">{data.tglBuat}</td></tr>
          <tr><td className="px-2 border border-black">Tgl Revisi</td><td className="px-2 border border-black">{data.tglRevisi}</td></tr>
          <tr><td className="px-2 border border-black">Tgl Pengesahan</td><td className="px-2 border border-black">{data.tglPengesahan}</td></tr>
          <tr><td className="px-2 border border-black">Disahkan oleh</td><td className="px-2 border border-black font-bold uppercase underline">{data.disahkanOleh}</td></tr>
          <tr>
            <td colSpan="3" className="border border-black"></td>
            <td className="px-2 py-6 border border-black font-bold align-middle uppercase text-center bg-slate-100" colSpan="2">
              {data.judulSop}
            </td>
          </tr>
        </tbody>
      </table>

      <div className="grid grid-cols-2 border-l border-r border-black">
        <Section title="Dasar Hukum" list={data.dasarHukum} />
        <Section title="Kualifikasi Pelaksana" list={data.kualifikasi} />
        <Section title="Keterkaitan" list={data.keterkaitan} />
        <Section title="Peralatan/Perlengkapan" list={data.peralatan} />
        <Section title="Peringatan" list={data.peringatan} />
        <Section title="Pencatatan dan Pendataan" list={data.pendataan} />
      </div>
    </div>
  );
};

const Section = ({ title, list }) => (
  <div className="border-b border-black">
    <div className="bg-slate-200 text-center font-bold border-b border-black py-1 uppercase text-[10px]">{title}</div>
    <ol className="list-decimal pl-7 pr-2 py-2 text-[10px] min-h-[60px]">
      {list.map((v, i) => <li key={i}>{v}</li>)}
    </ol>
  </div>
);

const KonsepDua = ({ data }) => {
  const pelaksanaHeaders = ["Petugas UKS", "Petugas Kebersihan", "Sarpras"];
  return (
    <div className="bg-white p-4 border border-black shadow-sm mx-auto" style={{ width: '210mm' }}>
      <h3 className="text-center font-bold mb-4 uppercase underline text-[12px]">PROSEDUR {data.judulSop}</h3>
      <table className="w-full border-collapse border border-black text-[9px]">
        <thead className="bg-slate-50 text-center align-middle">
          <tr>
            <th rowSpan="2" className="border border-black px-1 w-6">No</th>
            <th rowSpan="2" className="border border-black px-2 w-[35%]">Uraian Prosedur</th>
            <th colSpan="3" className="border border-black py-1 uppercase">Pelaksana</th>
            <th colSpan="3" className="border border-black py-1 uppercase font-bold">Mutu Baku</th>
            <th rowSpan="2" className="border border-black px-2 uppercase">Ket</th>
          </tr>
          <tr>
            {pelaksanaHeaders.map(h => <th key={h} className="border border-black px-1 text-[7px] w-14 font-normal italic">{h}</th>)}
            <th className="border border-black px-1 text-[7px] font-normal uppercase">Persyaratan</th>
            <th className="border border-black px-1 text-[7px] font-normal uppercase w-10">Waktu</th>
            <th className="border border-black px-1 text-[7px] font-normal uppercase">Output</th>
          </tr>
        </thead>
        <tbody>
          {data.prosedur.map((item, idx) => (
            <tr key={item.id}>
              <td className="border border-black text-center h-12">{idx + 1}</td>
              <td className="border border-black px-2 py-1 leading-tight">{item.uraian}</td>
              {pelaksanaHeaders.map(h => (
                <td key={h} className="border border-black relative text-center">
                  {item.pelaksana === h && <Shape type={item.tipe} />}
                </td>
              ))}
              <td className="border border-black px-1 text-[8px] italic">{item.syarat}</td>
              <td className="border border-black px-1 text-[8px] text-center">{item.waktu}</td>
              <td className="border border-black px-1 text-[8px] uppercase font-bold">{item.output}</td>
              <td className="border border-black px-1 text-[8px]">Sesuai Juknis</td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="mt-10 flex justify-end text-[10px]">
        <div className="w-1/3 leading-snug">
          <p>Dikeluarkan di : Surabaya</p>
          <p className="border-b border-black pb-1 mb-1">Pada Tanggal : {data.ttd.tanggal}</p>
          <p className="font-bold">KEPALA SMP NEGERI 12 SURABAYA,</p>
          <div className="h-16"></div>
          <p className="font-bold underline uppercase">{data.ttd.nama}</p>
          <p>{data.ttd.pangkat}</p>
          <p>NIP {data.ttd.nip}</p>
        </div>
      </div>
    </div>
  );
};

const Shape = ({ type }) => {
  return (
    <div className="absolute inset-0 flex flex-col items-center justify-center p-0">
      <div className="w-px h-full bg-black absolute z-0 opacity-50"></div>
      {type === 'start' ? (
        <div className="w-10 h-4 border border-black rounded-full bg-white z-10 flex items-center justify-center text-[6px] font-bold">START</div>
      ) : type === 'decision' ? (
        <div className="w-5 h-5 border border-black rotate-45 bg-white z-10"></div>
      ) : (
        <div className="w-8 h-4 border border-black bg-white z-10"></div>
      )}
    </div>
  );
};

export default App;
